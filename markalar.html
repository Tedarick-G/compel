<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tedarick — Aide ↔ T-Soft (Basit)</title>
  <style>
    :root{
      color-scheme:dark;

      --bg-main:#1E1E1E;
      --bg-panel:#252525;
      --bg-elevated:#2D2D2D;
      --bg-hover:#343434;

      --border:#3A3A3A;
      --border-2:#4A4A4A;

      --text:#E6E6E6;
      --text-2:#A0A0A0;

      --accent:#e83c61;
      --accent-hover:#ff5579;
      --accent-soft:rgba(232,60,97,.12);
      --accent-glow:rgba(232,60,97,.55);

      --ok:#86efac;
      --bad:#ff4d79;
      --warn:#fcd34d;

      --thead-bg:#1b1b1b;

      --overlay:rgba(0,0,0,.55);
      --stroke:#000;

      --warn-halo-1:rgba(245,245,245,.38);
      --warn-halo-2:rgba(245,245,245,.20);
    }

    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--bg-main);
      color:var(--text);
      font-size:15px;
    }

    .layout{max-width:1100px;margin:0 auto;padding:12px}
    .siteTitle{
      text-align:center;
      font-size:22px;
      font-weight:1300;
      letter-spacing:3.6px;
      padding:8px 0 12px;
    }

    .panel{
      background:var(--bg-panel);
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      margin-bottom:10px;
    }

    .topRow{display:flex;gap:8px;flex-wrap:wrap;align-items:stretch}
    button,.file,select,textarea{
      background:var(--bg-elevated);
      color:var(--text);
      border:1px solid var(--border-2);
      border-radius:10px;
      font-weight:900;
      font-size:14px;
      box-sizing:border-box;
    }
    button,.file,select{height:36px}
    button{padding:0 12px;cursor:pointer}
    button:hover,.file:hover,select:hover,textarea:hover{background:var(--bg-hover);border-color:var(--border-2)}
    button:disabled{opacity:.55;cursor:not-allowed}
    button:disabled:hover{background:var(--bg-elevated);border-color:var(--border-2)}

    .file{display:flex;align-items:center;gap:8px;padding:0 10px;cursor:pointer;user-select:none}
    .file input{display:none}
    .fbtn{white-space:nowrap}
    .fname{font-weight:800;opacity:.92;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:240px}
    .grow{flex:1 1 auto}

    textarea{
      width:100%;
      min-height:140px;
      padding:10px;
      resize:vertical;
      font-weight:800;
      line-height:1.35;
      background:var(--bg-main);
    }

    .ibox{
      height:36px;
      display:flex;
      align-items:center;
      gap:6px;
      padding:0 10px;
      border:1px solid var(--border);
      border-radius:10px;
      background:var(--bg-panel);
      margin-left:auto;
      overflow-x:auto;
      scrollbar-width:thin;
    }
    .chip{
      padding:3px 9px;
      border:1px solid var(--border-2);
      border-radius:999px;
      background:var(--bg-main);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-weight:1000;
      font-size:13px;
      line-height:1.1;
      color:var(--text);
    }
    .chip.ok{color:var(--ok)}
    .chip.bad{color:var(--bad)}
    .chip.warn{color:var(--warn)}
    .chip.muted{opacity:.88;font-weight:900;color:var(--text-2)}

    .rowSep{height:1px;background:var(--border);opacity:.7;margin:10px 2px;border-radius:999px}

    .listTitleBar{
      text-align:center;
      font-weight:1300;
      font-size:16px;
      letter-spacing:.06em;
      opacity:.95;
      line-height:1.25;
      padding:6px 0 8px;
    }

    .tableWrap{
      overflow:auto;
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--bg-panel);
    }
    table{width:100%;border-collapse:collapse;table-layout:fixed}
    th,td{
      border-bottom:1px solid var(--border);
      padding:9px 6px;
      text-align:center;
      vertical-align:middle;
      font-size:14px;
      line-height:1.1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    th{
      position:sticky;top:0;z-index:2;
      background:var(--thead-bg);
      font-weight:1100;
      padding:8px 6px;
    }
    tbody tr:hover{background:var(--bg-elevated)}
    td.left{text-align:left}
    td.seqCell{font-weight:1100}

    /* kırmızı halo + yanıp sönme (T-Soft stok yanlışsa) */
    @keyframes blinkBad{
      0%{opacity:1}
      50%{opacity:.32}
      100%{opacity:1}
    }
    .flagBad{
      color:var(--bad)!important;
      font-weight:1200!important;
      animation:blinkBad 900ms ease-in-out infinite;
      text-shadow:
        -0.8px 0 var(--stroke),
         0.8px 0 var(--stroke),
         0 -0.8px var(--stroke),
         0  0.8px var(--stroke),
         0 0 2px var(--warn-halo-2),
         0 0 10px var(--warn-halo-1);
    }
    .mutedCell{color:var(--text-2);font-weight:900}
    .okCell{color:var(--ok);font-weight:1100}
    .warnCell{color:var(--warn);font-weight:1100}

    .note{font-size:12px;color:var(--text-2);font-weight:900;line-height:1.35}
  </style>
</head>
<body>
  <div class="layout">
    <div class="siteTitle">Tedarick — Aide ↔ T-Soft</div>

    <div class="panel">
      <div class="topRow">
        <label class="file grow" title="T-Soft CSV seç">
          <span class="fbtn">T-Soft CSV</span>
          <span class="fname" id="tsoftName">Yükle</span>
          <input id="tsoftFile" type="file" accept=".csv,text/csv,.txt,text/plain" />
        </label>

        <button id="aideLoadBtn" class="file grow" type="button" title="Aide verisini yapıştırıp yükle">
          <span class="fbtn">Aide Yapıştır & Yükle</span>
          <span class="fname" id="aideStat">—</span>
        </button>

        <select id="brandSel" style="min-width:220px" title="Marka seç">
          <option value="">Marka: —</option>
        </select>

        <button id="listBtn" title="Listele">Listele</button>

        <div class="ibox" id="infoBox">
          <span class="chip muted" id="stChip">Hazır</span>
          <span class="chip" id="tsoftChip">T-Soft:-</span>
          <span class="chip" id="aideChip">Aide:-</span>
          <span class="chip muted" id="sumChip">✓0 • ✕0</span>
        </div>
      </div>

      <div class="rowSep" aria-hidden="true"></div>

      <div class="note">
        • Eşleştirme: <b>T-Soft “Tedarikçi Ürün Kodu”</b> ↔ <b>Aide “Stok Kodu”</b> (0’lı/0’sız alternatifiyle)<br/>
        • T-Soft, Aide’ye göre ayarlanacağı için ana liste T-Soft ürünlerinden oluşur.<br/>
        • Eşleşmeyenler sayfanın en altında ayrıca listelenir.
      </div>

      <div style="height:10px"></div>
      <textarea id="aidePaste" placeholder="Aide tablosunu buraya yapıştır (TSV/CSV olabilir). Örn: Marka | Model | Stok Kodu | Stok ..."></textarea>
    </div>

    <div class="panel">
      <div class="listTitleBar" id="mainTitle">Liste</div>
      <div class="tableWrap"><table id="tMain"></table></div>
    </div>

    <div class="panel" id="unmatchedPanel" style="display:none">
      <div class="listTitleBar">Eşleşmeyen Ürünler</div>
      <div class="tableWrap"><table id="tUn"></table></div>
    </div>
  </div>

<script>
/* =========================
   Utils (senin dosyaların mantığı)
========================= */
const TR = "tr-TR";
const $ = id => document.getElementById(id);
const T = s => (s ?? "").toString().trim();
const D = s => (s ?? "").toString().replace(/[^\d]/g,"").trim();

function detectDelimiter(h){
  const c = ["\t",";",",","|"];
  let best = c[0], max = -1;
  for(const d of c){
    const k = (h.split(d).length - 1);
    if(k > max){ max = k; best = d; }
  }
  return best;
}

function parseDelimited(text){
  const lines = (text ?? "")
    .toString()
    .replace(/\r\n/g,"\n").replace(/\r/g,"\n")
    .split("\n");

  const first = lines.find(x => x.trim()) || "";
  const delim = detectDelimiter(first);

  const split = line => {
    const out = [];
    let cur = "", q = false;
    for(let i=0;i<line.length;i++){
      const ch = line[i];
      if(ch === '"'){
        if(q && line[i+1] === '"'){ cur += '"'; i++; }
        else q = !q;
      }else if(!q && ch === delim){
        out.push(cur); cur = "";
      }else{
        cur += ch;
      }
    }
    out.push(cur);
    return out.map(v => v.trim());
  };

  let hdr = null, rows = [];
  for(const line of lines){
    if(!line || !line.trim()) continue;
    if(!hdr){ hdr = split(line); continue; }
    const vals = split(line);
    const obj = {};
    for(let i=0;i<hdr.length;i++) obj[hdr[i]] = vals[i] ?? "";
    rows.push(obj);
  }
  return { hdr: hdr || [], rows };
}

const normHeader = h => (h ?? "").toString().trim().toLocaleUpperCase(TR).replace(/\s+/g," ");
function pickColumn(rowObj, wanted){
  const map = new Map(Object.keys(rowObj).map(k => [normHeader(k), k]));
  for(const w of wanted){
    const k = map.get(normHeader(w));
    if(k) return k;
  }
  return null;
}

function stockToNumber(raw,{source}={}){
  const s = (raw ?? "").toString().trim();
  if(!s) return 0;
  if(source === "products" && s === "-") return 0;

  let t = s;
  if(t.includes(".") && t.includes(",")) t = t.replace(/\./g,"").replace(/,/g,".");
  else t = t.replace(/,/g,".");
  t = t.replace(/[^0-9.\-]/g,"");

  const n = parseFloat(t);
  return Number.isFinite(n) ? n : 0;
}
const inStock = (raw, opts) => stockToNumber(raw, opts) > 0;

function cleanCell(s){
  return (s ?? "").toString().replace(/\u00A0/g," ").trim().replace(/\s+/g," ");
}
function codeNorm(s){
  return cleanCell(s).toLocaleUpperCase(TR);
}
function codeAlt(n){
  const k = codeNorm(n);
  if(!k || !/^[0-9]+$/.test(k)) return "";
  return k.replace(/^0+(?=\d)/,"");
}

/* Brand normalize (match.js yaklaşımının sade hali) */
function bRaw(s){
  let x = cleanCell(s);
  if(!x) return "";
  try{ x = x.normalize("NFKD").replace(/[\u0300-\u036f]/g,""); }catch{}
  x = x.replace(/Ø/g,"O").replace(/ø/g,"o").toLocaleUpperCase(TR)
    .replace(/\u0130/g,"I").replace(/\u0131/g,"I")
    .replace(/Ğ/g,"G").replace(/Ü/g,"U").replace(/Ş/g,"S").replace(/Ö/g,"O").replace(/Ç/g,"C")
    .replace(/&/g," ")
    .replace(/[^A-Z0-9]+/g," ")
    .trim().replace(/\s+/g," ");
  return x;
}
const ALIAS = new Map([
  ["BEYER","BEYERDYNAMIC"],
  ["DENON","DENON DJ"],
  ["FOCUSRITE","FOCUSRITE"], // typo guard
  ["FOCUSRİTE","FOCUSRITE"],
  ["WARMAUDIO","WARM AUDIO"],
  ["UNIVERSAL","UNIVERSAL AUDIO"],
  ["KONIG MEYER","KÖNIG & MEYER"],
  ["KONIG","KÖNIG & MEYER"],
]);
function normBrand(s){
  const k = bRaw(s);
  if(!k) return "";
  const compact = k.replace(/\s+/g,"");
  return ALIAS.get(compact) || k;
}

/* =========================
   Aide parse (TSV/CSV + gürültülü paste fallback)
========================= */
function depotFromNoisyPaste(text){
  const FirmaDefault="Sescibaba";
  const N = s => !s || /^(Tümü|Sesçibaba Logo|Şirketler|Siparişler|Onay Bekleyen|Sipariş Listesi|İade Listesi|Sesçibaba Stokları|Stok Listesi|Ara|Previous|Next|E-Commerce Management.*|Showing\b.*|Marka\s+Model\s+Stok\s+Kodu.*|\d+)$/.test(s);
  const out = [];
  const lines = (text || "").split(/\r\n|\r|\n/);
  for(let l of lines){
    l = (l || "").replace(/\u00A0/g," ").trim();
    if(N(l) || !l.includes("\t")) continue;

    const a = l.split("\t").map(x=>x.trim()).filter(Boolean);
    if(a.length < 6) continue;

    let m="", mo="", k="", ac="", s="", w="", f=FirmaDefault;
    if(a.length === 6){
      m=a[0]; mo=a[1]; k=a[2]; ac=a[3]; s=a[4]; w=a[5];
    }else{
      m=a[0]; f=a.at(-1)||FirmaDefault; w=a.at(-2)||""; s=a.at(-3)||"";
      const mid=a.slice(1,-3); if(mid.length<3) continue;
      mo=mid.slice(0,-2).join(" "); k=mid.at(-2)||""; ac=mid.at(-1)||"";
    }

    const stokStr = String(s ?? "").trim();
    if(!stokStr || !/^-?\d+(?:[.,]\d+)?$/.test(stokStr)) continue;

    out.push({"Marka":m,"Model":mo,"Stok Kodu":k,"Açıklama":ac,"Stok":stokStr,"Ambar":w,"Firma":f});
  }
  return out;
}

function parseAide(text){
  const raw = (text ?? "").toString();
  if(!raw.trim()) return { rows: [], C: null, err: "Aide verisi boş." };

  // 1) normal parseDelimited dene
  try{
    const p = parseDelimited(raw);
    const rows = p.rows || [];
    if(rows.length){
      const sample = rows[0];
      const stokKodu = pickColumn(sample, ["Stok Kodu","StokKodu","STOK KODU","Stock Code"]);
      const stok     = pickColumn(sample, ["Stok","Miktar","Qty","Quantity"]);
      const marka    = pickColumn(sample, ["Marka","MARKA","Brand","BRAND"]);
      const urunAdi   = pickColumn(sample, ["Model","MODEL","Ürün Adı","Urun Adi","Ürün Adi","Product Name","Product"]);
      if(stokKodu && stok){
        return { rows, C: { stokKodu, stok, marka, urunAdi }, err: "" };
      }
    }
  }catch{}

  // 2) gürültülü paste fallback
  const r2 = depotFromNoisyPaste(raw);
  if(!r2.length) return { rows: [], C: null, err: "Aide verisi çözümlenemedi. (Tablolu kopya bekleniyordu.)" };
  return { rows: r2, C: { stokKodu:"Stok Kodu", stok:"Stok", marka:"Marka", urunAdi:"Model" }, err: "" };
}

/* =========================
   T-Soft parse
========================= */
function parseTsoft(text){
  const raw = (text ?? "").toString();
  if(!raw.trim()) return { rows: [], C: null, err: "T-Soft CSV boş." };

  let p;
  try{ p = parseDelimited(raw); }catch{ return { rows: [], C: null, err: "T-Soft CSV okunamadı." }; }
  const rows = p.rows || [];
  if(!rows.length) return { rows: [], C: null, err: "T-Soft CSV boş." };

  const s2 = rows[0];
  const C = {
    sup:   pickColumn(s2, ["Tedarikçi Ürün Kodu","Tedarikci Urun Kodu","Tedarikçi Urun Kodu","Supplier Product Code"]),
    marka: pickColumn(s2, ["Marka","MARKA","Brand","BRAND"]),
    ad:    pickColumn(s2, ["Ürün Adı","Urun Adi","Ürün Adi","Product Name","Product"]),
    stok:  pickColumn(s2, ["Stok","Stock"]),
  };
  const miss = ["sup","marka","ad","stok"].filter(k => !C[k]);
  if(miss.length) return { rows: [], C: null, err: "T-Soft CSV sütunları eksik: " + miss.join(", ") };

  return { rows, C, err: "" };
}

/* =========================
   UI + state
========================= */
let TSOFT = { rows: [], C: null, brands: [] };
let AIDE  = { rows: [], C: null, brands: [] };

function setChip(id, txt, cls=""){
  const el = $(id);
  if(!el) return;
  el.textContent = String(txt ?? "");
  el.className = "chip" + (cls ? (" " + cls) : "");
}
function setStatus(txt, cls="muted"){
  const el = $("stChip");
  if(!el) return;
  setChip("stChip", txt, cls);
}

function fillBrands(){
  const sel = $("brandSel");
  const old = sel.value || "";

  // marka listesi: T-Soft markalarını baz alalım (t-soft’a göre liste)
  const set = new Map(); // norm -> display
  const push = (disp) => {
    const d = cleanCell(disp);
    if(!d) return;
    const n = normBrand(d) || bRaw(d);
    if(!n) return;
    if(!set.has(n)) set.set(n, d);
  };

  if(TSOFT.C){
    for(const r of TSOFT.rows){
      push(r[TSOFT.C.marka]);
    }
  }
  if(AIDE.C){
    for(const r of AIDE.rows){
      push(r[AIDE.C.marka] ?? r["Marka"]);
    }
  }

  const arr = [...set.entries()]
    .map(([n,d]) => ({n,d}))
    .sort((a,b)=>a.d.localeCompare(b.d,"tr",{sensitivity:"base"}));

  sel.innerHTML = `<option value="">Marka: —</option>` + arr.map(x => {
    const v = x.n;
    const t = x.d;
    const selAttr = (old && old === v) ? " selected" : "";
    return `<option value="${escapeHtml(v)}"${selAttr}>${escapeHtml(t)}</option>`;
  }).join("");
}

function escapeHtml(s){
  return (s ?? "").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

/* =========================
   Matching + render
========================= */
function buildAideIndex(selectedBrandNorm){
  const idx = new Map(); // codeNorm or alt -> {sum, name, brandDisp}
  const seenCodeToPrimary = new Map(); // primary code (normalized) -> true
  const byBrand = (r) => {
    const raw = (AIDE.C?.marka ? r[AIDE.C.marka] : r["Marka"]) ?? "";
    return normBrand(raw) || bRaw(raw);
  };
  const nameOf = (r) => {
    const k = AIDE.C?.urunAdi;
    const v = k ? r[k] : (r["Model"] ?? r["Ürün Adı"] ?? r["Urun Adi"] ?? "");
    return cleanCell(v);
  };

  for(const r of (AIDE.rows || [])){
    const brN = byBrand(r);
    if(selectedBrandNorm && brN !== selectedBrandNorm) continue;

    const codeRaw = AIDE.C?.stokKodu ? r[AIDE.C.stokKodu] : r["Stok Kodu"];
    const code = codeNorm(codeRaw);
    if(!code) continue;

    const stockRaw = AIDE.C?.stok ? r[AIDE.C.stok] : r["Stok"];
    const num = stockToNumber(stockRaw, {source:"aide"});
    const nm = nameOf(r);

    // primary entry by exact normalized code
    if(!idx.has(code)) idx.set(code, { sum: 0, name: nm, code: code, rawCodes: new Set() });
    const it = idx.get(code);
    it.sum += num;
    if(!it.name && nm) it.name = nm;
    it.rawCodes.add(cleanCell(codeRaw));

    // alt entry (strip leading zeros)
    const alt = codeAlt(code);
    if(alt && alt !== code){
      if(!idx.has(alt)) idx.set(alt, { sum: 0, name: it.name, code: alt, rawCodes: new Set() });
      const it2 = idx.get(alt);
      it2.sum += num;
      if(!it2.name && nm) it2.name = nm;
      it2.rawCodes.add(cleanCell(codeRaw));
    }

    seenCodeToPrimary.set(code, true);
  }

  return { idx, primaries: new Set(seenCodeToPrimary.keys()) };
}

function listSelected(){
  if(!TSOFT.C){ setStatus("T-Soft yükleyin.", "bad"); return; }
  if(!AIDE.C){ setStatus("Aide verisini yapıştırıp yükleyin.", "bad"); return; }

  const brN = $("brandSel").value || "";
  if(!brN){ setStatus("Marka seçin.", "warn"); return; }

  const brDisp = (() => {
    // select text as display
    const sel = $("brandSel");
    const opt = sel.options[sel.selectedIndex];
    return opt ? opt.textContent.trim() : brN;
  })();

  $("mainTitle").textContent = `${brDisp} — Liste`;

  const { idx: aideIdx, primaries: aidePrimaryCodes } = buildAideIndex(brN);

  // Main table columns
  const COLS = ["Sıra","Marka","Ürün Kodu","Ürün Adı","Aide Stok","T-Soft Stok"];
  const head = `<thead><tr>${COLS.map(c=>`<th title="${escapeHtml(c)}">${escapeHtml(c)}</th>`).join("")}</tr></thead>`;

  // filter T-Soft by brand
  const tRows = (TSOFT.rows || []).filter(r => {
    const rawBr = r[TSOFT.C.marka];
    const n = normBrand(rawBr) || bRaw(rawBr);
    return n === brN;
  });

  // Index T-Soft codes for Aide-only unmatched later
  const tsoftCodes = new Set();

  let matched = 0, total = 0;
  const bodyRows = [];
  const unTsoftNoAide = []; // tsoft rows missing aide match
  for(const r of tRows){
    total++;
    const code = cleanCell(r[TSOFT.C.sup]);
    const codeN = codeNorm(code);
    const alt = codeAlt(codeN);
    tsoftCodes.add(codeN);
    if(alt) tsoftCodes.add(alt);

    const name = cleanCell(r[TSOFT.C.ad]);
    const tStockRaw = r[TSOFT.C.stok];
    const tHas = inStock(tStockRaw, {source:"products"});
    const tLbl = tHas ? "Stokta Var" : "Stokta Yok";

    const aHit = (codeN && aideIdx.get(codeN)) || (alt && aideIdx.get(alt)) || null;
    const aNum = aHit ? Number(aHit.sum || 0) : 0;
    const aHas = aNum > 0;
    const aLbl = aHas ? "Stokta Var" : "Stokta Yok";

    const bad = (aHas && !tHas); // istenen kırmızı yanıp sönme senaryosu
    const tCls = bad ? "flagBad" : (tHas ? "okCell" : "mutedCell");
    const aCls = aHas ? "okCell" : "mutedCell";

    if(aHit) matched++;
    else unTsoftNoAide.push({ code, name, tLbl });

    const seq = String(bodyRows.length + 1).padStart(2,"0");

    bodyRows.push(
      `<tr>
        <td class="seqCell" title="${seq}">${seq}</td>
        <td title="${escapeHtml(brDisp)}">${escapeHtml(brDisp)}</td>
        <td title="${escapeHtml(code)}">${escapeHtml(code)}</td>
        <td class="left" title="${escapeHtml(name)}">${escapeHtml(name)}</td>
        <td class="${aCls}" title="${escapeHtml(aLbl + (aHit ? (" ("+aNum+")") : ""))}">${escapeHtml(aLbl)}</td>
        <td class="${tCls}" title="${escapeHtml(tLbl)}">${escapeHtml(tLbl)}</td>
      </tr>`
    );
  }

  const table = `<table>
    <colgroup>
      <col style="width:7%">
      <col style="width:14%">
      <col style="width:14%">
      <col style="width:37%">
      <col style="width:14%">
      <col style="width:14%">
    </colgroup>
    ${head}
    <tbody>${bodyRows.join("") || `<tr><td colspan="6" class="mutedCell">Bu markada T-Soft ürünü bulunamadı.</td></tr>`}</tbody>
  </table>`;
  $("tMain").innerHTML = table;

  // Aide-only unmatched (selected brand): codes that don't exist in T-Soft set
  const unAideNoTsoft = [];
  for(const code of aidePrimaryCodes){
    if(!code) continue;
    const alt2 = codeAlt(code);
    const has = tsoftCodes.has(code) || (alt2 && tsoftCodes.has(alt2));
    if(has) continue;
    const it = aideIdx.get(code);
    if(!it) continue;
    const nm = it.name || "";
    unAideNoTsoft.push({ code: code, name: nm, aNum: Number(it.sum || 0) });
  }
  unAideNoTsoft.sort((a,b)=>String(a.name).localeCompare(String(b.name),"tr",{sensitivity:"base"}));

  // Unmatched section
  const unPanel = $("unmatchedPanel");
  const anyUn = unTsoftNoAide.length || unAideNoTsoft.length;
  if(!anyUn){
    unPanel.style.display = "none";
  }else{
    unPanel.style.display = "";
    const UCOLS = ["Kaynak","Ürün Kodu","Ürün Adı","Aide Stok","T-Soft Stok"];
    const uHead = `<thead><tr>${UCOLS.map(c=>`<th title="${escapeHtml(c)}">${escapeHtml(c)}</th>`).join("")}</tr></thead>`;

    const uRows = [];
    // T-Soft var, Aide yok
    for(const x of unTsoftNoAide){
      uRows.push(`<tr>
        <td class="warnCell" title="T-Soft’ta var, Aide’de eşleşmedi">T-Soft</td>
        <td title="${escapeHtml(x.code)}">${escapeHtml(x.code || "—")}</td>
        <td class="left" title="${escapeHtml(x.name)}">${escapeHtml(x.name || "—")}</td>
        <td class="mutedCell">—</td>
        <td class="okCell" title="${escapeHtml(x.tLbl)}">${escapeHtml(x.tLbl)}</td>
      </tr>`);
    }
    // Aide var, T-Soft yok
    for(const x of unAideNoTsoft){
      const aLbl = (x.aNum > 0) ? "Stokta Var" : "Stokta Yok";
      uRows.push(`<tr>
        <td class="warnCell" title="Aide’de var, T-Soft’ta eşleşmedi">Aide</td>
        <td title="${escapeHtml(x.code)}">${escapeHtml(x.code || "—")}</td>
        <td class="left" title="${escapeHtml(x.name)}">${escapeHtml(x.name || "—")}</td>
        <td class="${x.aNum>0 ? "okCell" : "mutedCell"}" title="${escapeHtml(aLbl + " ("+x.aNum+")")}">${escapeHtml(aLbl)}</td>
        <td class="mutedCell">—</td>
      </tr>`);
    }

    $("tUn").innerHTML = `<table>
      <colgroup>
        <col style="width:12%">
        <col style="width:16%">
        <col style="width:44%">
        <col style="width:14%">
        <col style="width:14%">
      </colgroup>
      ${uHead}
      <tbody>${uRows.join("")}</tbody>
    </table>`;
  }

  setChip("sumChip", `✓${matched} • ✕${Math.max(0,total-matched)}`, "muted");
  setStatus("Hazır", "ok");
}

/* =========================
   Event handlers
========================= */
let lastAideRaw = "";

$("tsoftFile").addEventListener("change", async (e) => {
  const f = e.target.files?.[0];
  $("tsoftName").textContent = f ? "Seçildi" : "Yükle";
  $("tsoftName").title = f ? f.name : "Yükle";

  if(!f){
    TSOFT = { rows: [], C: null, brands: [] };
    setChip("tsoftChip", "T-Soft:-");
    fillBrands();
    return;
  }

  try{
    setStatus("T-Soft okunuyor…", "warn");
    const txt = await f.text();
    const p = parseTsoft(txt);
    if(p.err){ setStatus(p.err, "bad"); alert(p.err); return; }
    TSOFT = { rows: p.rows, C: p.C, brands: [] };
    setChip("tsoftChip", `T-Soft:${TSOFT.rows.length}`);
    setStatus("Hazır", "ok");
    fillBrands();
  }catch(err){
    console.error(err);
    setStatus("T-Soft okunamadı.", "bad");
    alert("T-Soft okunamadı.");
  }
});

$("aideLoadBtn").addEventListener("click", () => {
  const raw = $("aidePaste").value || "";
  lastAideRaw = raw;

  try{
    setStatus("Aide okunuyor…", "warn");
    const p = parseAide(raw);
    if(p.err){ setStatus(p.err, "bad"); alert(p.err); return; }
    AIDE = { rows: p.rows, C: p.C, brands: [] };
    $("aideStat").textContent = `Yüklendi`;
    $("aideStat").title = `Aide yüklü (${AIDE.rows.length})`;
    setChip("aideChip", `Aide:${AIDE.rows.length}`);
    setStatus("Hazır", "ok");
    fillBrands();
  }catch(err){
    console.error(err);
    setStatus("Aide okunamadı.", "bad");
    alert("Aide okunamadı.");
  }
});

$("listBtn").addEventListener("click", () => {
  try{ listSelected(); }catch(err){
    console.error(err);
    setStatus("Listeleme hatası (konsol).", "bad");
    alert("Listeleme hatası. Konsola bakın.");
  }
});

$("brandSel").addEventListener("change", () => {
  // marka değişince tabloyu temizle (isteğe bağlı)
  $("tMain").innerHTML = "";
  $("unmatchedPanel").style.display = "none";
  setChip("sumChip", "✓0 • ✕0", "muted");
});

/* init */
setChip("tsoftChip","T-Soft:-");
setChip("aideChip","Aide:-");
setChip("sumChip","✓0 • ✕0","muted");
</script>
</body>
</html>
