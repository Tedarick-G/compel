<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Marka Toplayıcı (Aide + T-Soft)</title>
  <style>
    :root { color-scheme: dark; }
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:#1e1e1e; color:#e6e6e6; padding:16px;
    }
    h1{ margin:0 0 12px; font-size:20px; letter-spacing:.02em; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:stretch; }
    .card{
      background:#252525; border:1px solid #3a3a3a; border-radius:12px;
      padding:12px; flex:1 1 420px; min-width:min(420px, 100%);
    }
    label{ display:block; font-weight:800; margin-bottom:8px; }
    textarea{
      width:100%; height:220px; resize:vertical; box-sizing:border-box;
      background:#1e1e1e; color:#e6e6e6;
      border:1px solid #4a4a4a; border-radius:10px; padding:10px;
      font-weight:700;
    }
    input[type="file"]{
      width:100%;
      background:#1e1e1e; color:#e6e6e6;
      border:1px solid #4a4a4a; border-radius:10px; padding:10px;
    }
    button{
      background:#2d2d2d; color:#e6e6e6;
      border:1px solid #4a4a4a; border-radius:10px;
      font-weight:900; height:38px; padding:0 14px; cursor:pointer;
    }
    button:hover{ background:#343434; }
    .chips{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .chip{
      border:1px solid #4a4a4a; border-radius:999px; padding:4px 10px;
      background:#1e1e1e; font-weight:900;
    }
    .chip.ok{ color:#86efac; }
    .chip.warn{ color:#fcd34d; }
    .list{
      margin-top:10px;
      border:1px solid #3a3a3a; border-radius:12px;
      background:#252525; overflow:hidden;
    }
    .listHead{
      padding:10px 12px; background:#1b1b1b; border-bottom:1px solid #3a3a3a;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      position:sticky; top:0;
    }
    .listHead b{ font-size:14px; letter-spacing:.04em; }
    .listBody{ max-height:55vh; overflow:auto; }
    .item{
      padding:10px 12px; border-bottom:1px solid #3a3a3a;
      display:flex; justify-content:space-between; gap:10px;
    }
    .item:last-child{ border-bottom:0; }
    .muted{ opacity:.75; font-weight:800; }
    .small{ font-size:12px; opacity:.85; }
    .err{ color:#ff4d79; font-weight:900; }
  </style>
</head>
<body>
  <h1>Aide + T-Soft → Benzersiz Marka Listesi</h1>

  <div class="row">
    <div class="card">
      <label for="aidePaste">Aide verisini buraya yapıştır</label>
      <textarea id="aidePaste" placeholder="Aide stok tablosunu kopyala-yapıştır (TSV/CSV/karma)..."></textarea>
      <div class="chips">
        <span class="chip" id="aideCount">Aide: 0</span>
        <span class="chip warn" id="aideBrandCol">Marka sütunu: —</span>
      </div>
    </div>

    <div class="card">
      <label for="tsoftFile">T-Soft CSV yükle</label>
      <input id="tsoftFile" type="file" accept=".csv,text/csv,.txt,text/plain" />
      <div class="chips">
        <span class="chip" id="tsoftCount">T-Soft: 0</span>
        <span class="chip warn" id="tsoftBrandCol">Marka sütunu: —</span>
      </div>

      <div style="height:12px"></div>

      <div class="row" style="gap:10px">
        <button id="btnBuild">Markaları Listele</button>
        <button id="btnClear">Temizle</button>
      </div>

      <div style="margin-top:10px" class="small muted">
        Not: Marka sütunu otomatik bulunur (Marka / MARKA / Brand / BRAND).
        Bulunamazsa liste boş kalır.
      </div>
      <div id="status" style="margin-top:10px"></div>
    </div>
  </div>

  <div class="list" style="margin-top:14px">
    <div class="listHead">
      <b>BENZERSİZ MARKALAR</b>
      <span class="muted" id="uniqCount">0 adet</span>
    </div>
    <div class="listBody" id="brandList"></div>
  </div>

<script>
  // ====== utils.js tarzı mini yardımcılar ======
  const TR = "tr-TR";
  const T = s => (s ?? "").toString().trim();
  const normHeader = h => (h ?? "").toString().trim().toLocaleUpperCase(TR).replace(/\s+/g," ");

  function detectDelimiter(h){
    const c = ["\t",";",",","|"];
    let best = c[0], max = -1;
    for(const d of c){
      const k = (h.split(d).length - 1);
      if(k > max){ max = k; best = d; }
    }
    return best;
  }

  function parseDelimited(text){
    const lines = (text ?? "")
      .toString()
      .replace(/\r\n/g,"\n").replace(/\r/g,"\n")
      .split("\n");

    const first = lines.find(x => x.trim()) || "";
    const delim = detectDelimiter(first);

    const split = line => {
      const out = [];
      let cur = "", q = false;
      for(let i=0;i<line.length;i++){
        const ch = line[i];
        if(ch === '"'){
          if(q && line[i+1] === '"'){ cur += '"'; i++; }
          else q = !q;
        }else if(!q && ch === delim){
          out.push(cur); cur = "";
        }else{
          cur += ch;
        }
      }
      out.push(cur);
      return out.map(v => v.trim());
    };

    let hdr = null, rows = [];
    for(const line of lines){
      if(!line || !line.trim()) continue;
      if(!hdr){ hdr = split(line); continue; }
      const vals = split(line);
      const obj = {};
      for(let i=0;i<hdr.length;i++) obj[hdr[i]] = vals[i] ?? "";
      rows.push(obj);
    }
    return { hdr: hdr || [], rows };
  }

  function pickColumn(rowObj, wanted){
    const map = new Map(Object.keys(rowObj).map(k => [normHeader(k), k]));
    for(const w of wanted){
      const k = map.get(normHeader(w));
      if(k) return k;
    }
    return null;
  }

  // match.js tarafındaki "marka normalize" fikrinin basit hali:
  function normBrand(raw){
    let x = (raw ?? "").toString().replace(/\u00A0/g," ").trim();
    if(!x) return "";
    x = x.toLocaleUpperCase(TR).replace(/\s+/g," ").trim();
    return x;
  }

  // ====== app ======
  const $ = id => document.getElementById(id);

  let aideRows = [], aideBrandKey = null;
  let tsoftRows = [], tsoftBrandKey = null;

  function setStatus(msg, kind){
    const el = $("status");
    if(!msg){ el.innerHTML = ""; return; }
    const cls = (kind === "bad") ? "err" : "muted";
    el.innerHTML = `<span class="${cls}">${escapeHtml(msg)}</span>`;
  }

  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function updateCounts(){
    $("aideCount").textContent = `Aide: ${aideRows.length}`;
    $("tsoftCount").textContent = `T-Soft: ${tsoftRows.length}`;
    $("aideBrandCol").textContent = `Marka sütunu: ${aideBrandKey || "—"}`;
    $("tsoftBrandCol").textContent = `Marka sütunu: ${tsoftBrandKey || "—"}`;
  }

  function readAidePaste(){
    const raw = $("aidePaste").value || "";
    if(!raw.trim()){
      aideRows = []; aideBrandKey = null;
      updateCounts();
      return;
    }
    try{
      const p = parseDelimited(raw);
      aideRows = p.rows || [];
      const sample = aideRows[0] || {};
      aideBrandKey = pickColumn(sample, ["Marka","MARKA","Brand","BRAND"]);
    }catch(e){
      aideRows = []; aideBrandKey = null;
      setStatus("Aide verisi okunamadı.", "bad");
    }
    updateCounts();
  }

  async function readTsoftFile(file){
    tsoftRows = []; tsoftBrandKey = null;
    if(!file){ updateCounts(); return; }

    try{
      const txt = await file.text();
      const p = parseDelimited(txt);
      tsoftRows = p.rows || [];
      const sample = tsoftRows[0] || {};
      tsoftBrandKey = pickColumn(sample, ["Marka","MARKA","Brand","BRAND"]);
    }catch(e){
      tsoftRows = []; tsoftBrandKey = null;
      setStatus("T-Soft dosyası okunamadı.", "bad");
    }
    updateCounts();
  }

  function buildUniqueBrands(){
    setStatus("", "ok");

    const uniq = new Map(); // norm -> display
    const addFrom = (rows, brandKey, sourceName) => {
      if(!rows?.length) return;
      if(!brandKey) return;

      for(const r of rows){
        const raw = T(r[brandKey] ?? "");
        if(!raw) continue;
        const n = normBrand(raw);
        if(!n) continue;

        // ilk gördüğümüz “display” değerini sakla
        if(!uniq.has(n)) uniq.set(n, raw);
      }
    };

    addFrom(aideRows, aideBrandKey, "Aide");
    addFrom(tsoftRows, tsoftBrandKey, "T-Soft");

    // alfabetik sırala (TR)
    const arr = [...uniq.entries()]
      .map(([norm, disp]) => ({ norm, disp }))
      .sort((a,b) => a.norm.localeCompare(b.norm, "tr", { sensitivity:"base" }));

    $("uniqCount").textContent = `${arr.length} adet`;

    const list = $("brandList");
    list.innerHTML = arr.length
      ? arr.map((x,i)=>`
          <div class="item">
            <span><b>${i+1}.</b> ${escapeHtml(x.disp)}</span>
            <span class="muted small">${escapeHtml(x.norm)}</span>
          </div>
        `).join("")
      : `<div class="item"><span class="muted">Henüz marka yok. Aide yapıştırın ve/veya T-Soft yükleyin.</span></div>`;
  }

  // events
  $("aidePaste").addEventListener("input", () => {
    readAidePaste();
  });

  $("tsoftFile").addEventListener("change", async (e) => {
    await readTsoftFile(e.target.files?.[0]);
  });

  $("btnBuild").addEventListener("click", () => {
    // en günceli oku
    readAidePaste();
    buildUniqueBrands();

    // uyarı mesajları
    const warns = [];
    if(aideRows.length && !aideBrandKey) warns.push("Aide içinde 'Marka' sütunu bulunamadı.");
    if(tsoftRows.length && !tsoftBrandKey) warns.push("T-Soft içinde 'Marka' sütunu bulunamadı.");
    if(!aideRows.length && !tsoftRows.length) warns.push("Aide boş ve T-Soft seçilmedi.");

    if(warns.length) setStatus(warns.join(" "), "bad");
  });

  $("btnClear").addEventListener("click", () => {
    $("aidePaste").value = "";
    $("tsoftFile").value = "";
    aideRows = []; tsoftRows = [];
    aideBrandKey = null; tsoftBrandKey = null;
    updateCounts();
    $("brandList").innerHTML = `<div class="item"><span class="muted">Temizlendi.</span></div>`;
    $("uniqCount").textContent = "0 adet";
    setStatus("", "ok");
  });

  // init
  updateCounts();
  buildUniqueBrands();
</script>
</body>
</html>
